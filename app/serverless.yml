service: bike-rides-api

frameworkVersion: '3'

custom:
  tags:
    App: BikeRidesApi
    Env: ${opt:stage}
  vpc:
    securityGroupIds:
      - ${ssm:/${opt:stage}/network/default-security-group-id}
    subnetIds: ${ssm:/${opt:stage}/network/private-subnet-ids}

provider:
  name: aws
  stage: ${opt:stage}
  region: ${opt:region}
  runtime: provided.al2
  memorySize: 512
  tags: ${self:custom.tags}
  stackTags: ${self:custom.tags}
  deploymentBucket:
    tags: ${self:custom.tags}
    blockPublicAccess: true
  iam:
    role:
      managedPolicies:
        - '${ssm:/${opt:stage}/api/lambda-policy-arn}'
  environment:
    HTTPS: true
    APP_ENV: prod
    APP_SECRET: 'bref-ssm:/${opt:stage}/api/app-secret'
    DATABASE_URL: 'bref-ssm:/${opt:stage}/api/db-url'

plugins:
  - ./vendor/bref/bref

functions:
  api-billing:
    handler: public/index.php
    runtime: php-83-fpm
    vpc: ${self:custom.vpc}
    timeout: 10
    url: true
    environment:
      RIDES_API_URL:
        Fn::GetAtt: ["ApiDashridesLambdaFunctionUrl", "FunctionUrl"]

  api-rides:
    handler: public/index.php
    runtime: php-83-fpm
    vpc: ${self:custom.vpc}
    timeout: 10
    url: true

  console:
    handler: bin/console
    runtime: php-83-console
    vpc: ${self:custom.vpc}
    timeout: 120
    environment:
      RIDES_API_URL:
        Fn::GetAtt: ["ApiDashridesLambdaFunctionUrl", "FunctionUrl"]
